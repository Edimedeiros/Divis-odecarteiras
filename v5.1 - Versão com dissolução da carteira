/**
 * FUNÃ‡ÃƒO PRINCIPAL: Gerencia o inÃ­cio do fluxo.
 */
function executarAutomacaoCompleta() {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const ui = SpreadsheetApp.getUi();
  
  const menuInicial = ui.alert("ðŸš€ GestÃ£o de Carteiras", "O que vocÃª deseja fazer?\n\n[SIM] - Criar novas carteiras\n[NÃƒO] - Dissolver carteiras existentes", ui.ButtonSet.YES_NO_CANCEL);
  
  if (menuInicial == ui.Button.CANCEL) return;

  if (menuInicial == ui.Button.YES) {
    const prompt = ui.prompt("Montagem de Carteira", "Quantas novas carteiras vocÃª deseja montar?", ui.ButtonSet.OK_CANCEL);
    if (prompt.getSelectedButton() !== ui.Button.OK) return;
    const nNovas = parseInt(prompt.getResponseText());
    if (isNaN(nNovas) || nNovas <= 0) return ui.alert("Insira um nÃºmero vÃ¡lido.");
    
    unificarDados("CRIAR");
    distribuirCarteiras("CRIAR", nNovas);

  } else {
    const abaClientes = ss.getSheetByName("Tabela clientes");
    const dados = abaClientes.getDataRange().getValues();
    const cabecalho = dados[0];
    const idxCS = cabecalho.findIndex(c => c.toString().toUpperCase().includes("CS"));
    
    let analistas = [...new Set(dados.slice(1).map(r => r[idxCS]).filter(c => c !== ""))].sort();
    let listaTxt = analistas.map((a, i) => (i + 1) + ") " + a).join("\n");
    
    const promptDissolver = ui.prompt("ðŸ—‘ï¸ Dissolver Carteiras", 
      "Digite os NÃšMEROS dos CSs que saÃ­ram (separe por vÃ­rgula, ex: 1, 3):\n\n" + listaTxt, 
      ui.ButtonSet.OK_CANCEL);
    
    if (promptDissolver.getSelectedButton() !== ui.Button.OK) return;
    
    let escolhas = promptDissolver.getResponseText().split(",").map(n => parseInt(n.trim()) - 1);
    let nomesDissolver = escolhas.map(i => analistas[i]).filter(n => n !== undefined);
    
    if (nomesDissolver.length === 0) return ui.alert("SeleÃ§Ã£o invÃ¡lida.");

    unificarDados("DISSOLVER");
    distribuirCarteiras("DISSOLVER", nomesDissolver);
  }
}

/**
 * ETAPA 1: UNIFICAÃ‡ÃƒO (OTIMIZADA)
 */
function unificarDados(modo) {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const abaClientes = ss.getSheetByName("Tabela clientes");
  const abaJornada = ss.getSheetByName("Tabela jornada");
  const abaUnificados = ss.getSheetByName("Dados Unificados");
  
  ss.toast("Lendo base de dados...", "Iniciando", 2);

  const dadosClientes = abaClientes.getDataRange().getValues();
  const dadosJornada = abaJornada.getDataRange().getValues();
  const cabecalhoCli = dadosClientes[0];

  const norm = (t) => t ? t.toString().trim().toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "") : "";
  const localizar = (nome) => cabecalhoCli.findIndex(c => norm(c) === norm(nome));

  const idxId = localizar("ID ORIGINAL"), idxCS = localizar("CS"), idxLider = localizar("Lider Ongoing"),
        idxFase = localizar("Fase"), idxMRR = localizar("MRR"), idxNome = localizar("Cliente");

  let mapaClientes = {};
  for (let i = 1; i < dadosClientes.length; i++) {
    let id = dadosClientes[i][idxId].toString().trim();
    if (id) mapaClientes[id] = { nome: dadosClientes[i][idxNome], cs: dadosClientes[i][idxCS], fase: dadosClientes[i][idxFase], mrr: dadosClientes[i][idxMRR], lider: dadosClientes[i][idxLider] };
  }

  let listaUnificada = [];
  const fasesIncluir = ["mayday", "alert", "en route", "fly", "flying", "onboarding", "retomada"];
  const excluir = ["cancelado", "tratativa de cancelamento"];

  for (let j = 1; j < dadosJornada.length; j++) {
    if (j % 200 === 0) {
      ss.toast("Processando linhas: " + j + "...", "Etapa 1", 1);
    }
    let celula = dadosJornada[j][0].toString();
    if (!celula) continue;
    let texto = celula.toLowerCase();

    if (excluir.some(termo => texto.includes(termo))) continue;
    if (!fasesIncluir.some(termo => texto.includes(termo))) continue;

    let match = celula.match(/"(\d+)"\s*$/);
    if (match && mapaClientes[match[1]]) {
      let c = mapaClientes[match[1]];
      let faseFinal = c.fase.toString().replace(/Fly$/i, "Flying");
      listaUnificada.push([match[1], c.nome, c.cs, faseFinal, c.mrr, c.lider]);
    }
  }

  abaUnificados.clear().getRange(1, 1, 1, 6).setValues([["ID Original", "Cliente", "CS", "Fase", "MRR", "Lider Ongoing"]]).setFontWeight("bold").setBackground("#E0E0E0");
  if (listaUnificada.length > 0) abaUnificados.getRange(2, 1, listaUnificada.length, 6).setValues(listaUnificada);
}

/**
 * ETAPA 2: DISTRIBUIÃ‡ÃƒO (ULTRA RÃPIDA)
 */
function distribuirCarteiras(modo, parametro) {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const abaUnificados = ss.getSheetByName("Dados Unificados");
  const abaDepois = ss.getSheetByName("Depois");
  
  ss.toast("Balanceando MRR...", "Etapa 2", 2);

  const clientes = abaUnificados.getDataRange().getValues().slice(1);
  let analistasAlvo = [];
  let analistasAtuais = [...new Set(clientes.map(c => c[2]).filter(cs => cs !== ""))];

  if (modo === "CRIAR") {
    let novos = Array.from({length: parametro}, (_, i) => "Analista " + (i + 1));
    analistasAlvo = [...analistasAtuais, ...novos];
  } else {
    analistasAlvo = analistasAtuais.filter(a => !parametro.includes(a));
  }

  // OrdenaÃ§Ã£o Serpente
  clientes.sort((a, b) => {
    if (a[3] < b[3]) return -1;
    if (a[3] > b[3]) return 1;
    return (parseFloat(b[4]) || 0) - (parseFloat(a[4]) || 0);
  });

  let resultadoExibicao = [["ID ORIGINAL", "CLIENTE", "NOVO ANALISTA", "FASE", "MRR"]];
  let stats = {};
  analistasAlvo.forEach(n => stats[n] = { mayday: 0, alert: 0, enroute: 0, flying: 0, total: 0, mrr: 0 });

  clientes.forEach((cliente, i) => {
    let turno = Math.floor(i / analistasAlvo.length);
    let dir = i % analistasAlvo.length;
    let idxA = (turno % 2 === 0) ? dir : (analistasAlvo.length - 1 - dir);
    let analista = analistasAlvo[idxA];

    if (modo === "DISSOLVER" || (modo === "CRIAR" && analista.startsWith("Analista "))) {
      resultadoExibicao.push([cliente[0], cliente[1], analista, cliente[3], cliente[4]]);
    }

    let f = cliente[3].toString().toLowerCase();
    if (f.includes("mayday")) stats[analista].mayday++;
    else if (f.includes("alert")) stats[analista].alert++;
    else if (f.includes("en route")) stats[analista].enroute++;
    else if (f.includes("flying")) stats[analista].flying++;
    
    stats[analista].total = stats[analista].mayday + stats[analista].alert + stats[analista].enroute + stats[analista].flying;
    stats[analista].mrr += (parseFloat(cliente[4]) || 0);
  });

  // PREPARAÃ‡ÃƒO DO RESUMO (I AO O)
  let resumoData = [["Lista de Analistas", "Mayday", "Alert", "En Route", "Flying", "Total Clientes", "Total MRR"]];
  analistasAlvo.forEach(n => {
    resumoData.push([n, stats[n].mayday, stats[n].alert, stats[n].enroute, stats[n].flying, stats[n].total, stats[n].mrr]);
  });

  // GRAVAÃ‡ÃƒO ÃšNICA NA PLANILHA (O segredo da velocidade)
  ss.toast("Gravando na planilha...", "Finalizando", 2);
  abaDepois.clear().clearFormats();
  
  // Escreve a tabela principal (A:E)
  abaDepois.getRange(1, 1, resultadoExibicao.length, 5).setValues(resultadoExibicao);
  abaDepois.getRange(1, 1, 1, 5).setFontWeight("bold").setBackground("#444444").setFontColor("white");
  abaDepois.getRange(2, 5, resultadoExibicao.length - 1, 1).setNumberFormat("R$ #,##0.00");

  // Escreve o resumo (I:O)
  abaDepois.getRange(1, 9, resumoData.length, 7).setValues(resumoData);
  abaDepois.getRange(1, 9, 1, 7).setFontWeight("bold").setBackground("#F3F3F3");
  abaDepois.getRange(2, 15, resumoData.length - 1, 1).setNumberFormat("R$ #,##0.00");
  abaDepois.getRange(1, 9, resumoData.length, 7).setBorder(true, true, true, true, true, true);

  // Define larguras fixas em vez de autoResize (ECONOMIZA 20 SEGUNDOS)
  abaDepois.setColumnWidth(2, 250); // Cliente
  abaDepois.setColumnWidth(3, 150); // Analista
  abaDepois.setColumnWidth(9, 180); // Lista Analistas
  abaDepois.setColumnWidth(15, 120); // MRR
  
  SpreadsheetApp.getUi().alert("âœ… Processo concluÃ­do!");
}

function onOpen() {
  SpreadsheetApp.getUi().createMenu('ðŸš€ AutomaÃ§Ã£o CS').addItem('Rodar Processo Completo', 'executarAutomacaoCompleta').addToUi();
}
