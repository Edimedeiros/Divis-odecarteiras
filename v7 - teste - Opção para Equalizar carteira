/**
 * FUN√á√ÉO PRINCIPAL: Gerencia o menu de escolha e inicia o fluxo.
 */
function executarAutomacaoCompleta() {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const ui = SpreadsheetApp.getUi();
  
  // 1. MENU DE OP√á√ïES PERSONALIZADO
  const menuMsg = "Escolha o que deseja fazer:\n\n" +
                  "1) üöÄ Criar Novas Carteiras (Expans√£o)\n" +
                  "2) üóëÔ∏è Dissolver Carteiras (Sa√≠da de Analista)\n" +
                  "3) ‚öñÔ∏è Equalizar Carteiras (Reequilibrar time atual)\n\n" +
                  "Digite o n√∫mero da op√ß√£o:";
                  
  const promptInicial = ui.prompt("Gest√£o de Carteiras CS", menuMsg, ui.ButtonSet.OK_CANCEL);
  
  if (promptInicial.getSelectedButton() !== ui.Button.OK) return;
  const opcao = promptInicial.getResponseText().trim();

  if (opcao === "1") {
    // --- MODO CRIAR ---
    const prompt = ui.prompt("üöÄ Criar Carteiras", "Quantas novas carteiras voc√™ deseja montar?", ui.ButtonSet.OK_CANCEL);
    if (prompt.getSelectedButton() !== ui.Button.OK) return;
    const nNovas = parseInt(prompt.getResponseText());
    if (isNaN(nNovas) || nNovas <= 0) return ui.alert("Insira um n√∫mero v√°lido.");
    
    unificarDados("CRIAR");
    distribuirCarteiras("CRIAR", nNovas);

  } else if (opcao === "2") {
    // --- MODO DISSOLVER ---
    const analistas = obterAnalistasAtuais();
    let listaTxt = analistas.map((a, i) => (i + 1) + ") " + a).join("\n");
    const promptDiss = ui.prompt("üóëÔ∏è Dissolver Carteiras", "Digite os N√öMEROS dos CSs que sa√≠ram (ex: 1, 3):\n\n" + listaTxt, ui.ButtonSet.OK_CANCEL);
    
    if (promptDiss.getSelectedButton() !== ui.Button.OK) return;
    let escolhas = promptDiss.getResponseText().split(",").map(n => parseInt(n.trim()) - 1);
    let nomesDissolver = escolhas.map(i => analistas[i]).filter(n => n !== undefined);
    
    if (nomesDissolver.length === 0) return ui.alert("Sele√ß√£o inv√°lida.");
    unificarDados("DISSOLVER");
    distribuirCarteiras("DISSOLVER", nomesDissolver);

  } else if (opcao === "3") {
    // --- MODO EQUALIZAR ---
    ss.toast("Iniciando equaliza√ß√£o de toda a base...", "Modo Balan√ßo", 3);
    unificarDados("EQUALIZAR");
    distribuirCarteiras("EQUALIZAR", null);

  } else {
    ui.alert("Op√ß√£o inv√°lida. Digite 1, 2 ou 3.");
  }
}

/**
 * AUXILIAR: Obt√©m lista de CSs √∫nicos da aba Clientes
 */
function obterAnalistasAtuais() {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const aba = ss.getSheetByName("Tabela clientes");
  const dados = aba.getDataRange().getValues();
  const cabecalho = dados[0];
  const norm = (t) => t ? t.toString().trim().toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "") : "";
  const idxCS = cabecalho.findIndex(c => norm(c) === "cs");
  return [...new Set(dados.slice(1).map(r => r[idxCS]).filter(c => c !== ""))].sort();
}

/**
 * ETAPA 1: UNIFICA√á√ÉO
 */
function unificarDados(modo) {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const abaClientes = ss.getSheetByName("Tabela clientes");
  const abaJornada = ss.getSheetByName("Tabela jornada");
  const abaUnificados = ss.getSheetByName("Dados Unificados");
  
  const dadosClientes = abaClientes.getDataRange().getValues();
  const dadosJornada = abaJornada.getDataRange().getValues();
  const cabecalhoCli = dadosClientes[0];

  const norm = (t) => t ? t.toString().trim().toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "") : "";
  const localizar = (nome) => cabecalhoCli.findIndex(c => norm(c) === norm(nome));

  const idxId = localizar("ID ORIGINAL"), idxCS = localizar("CS"), idxLider = localizar("Lider Ongoing"),
        idxFase = localizar("Fase"), idxMRR = localizar("MRR"), idxNome = localizar("Cliente");

  let mapaClientes = {};
  for (let i = 1; i < dadosClientes.length; i++) {
    let id = dadosClientes[i][idxId].toString().trim();
    if (id) mapaClientes[id] = { nome: dadosClientes[i][idxNome], cs: dadosClientes[i][idxCS], fase: dadosClientes[i][idxFase], mrr: dadosClientes[i][idxMRR], lider: dadosClientes[i][idxLider] };
  }

  let listaUnificada = [];
  const fasesIncluir = ["mayday", "alert", "en route", "fly", "flying", "onboarding", "retomada"];
  const excluir = ["cancelado", "tratativa de cancelamento"];

  for (let j = 1; j < dadosJornada.length; j++) {
    let celula = dadosJornada[j][0].toString();
    if (!celula) continue;
    let texto = celula.toLowerCase();

    if (excluir.some(termo => texto.includes(termo))) continue;
    if (!fasesIncluir.some(termo => texto.includes(termo))) continue;

    let match = celula.match(/"(\d+)"\s*$/);
    if (match && mapaClientes[match[1]]) {
      let c = mapaClientes[match[1]];
      let faseFinal = c.fase.toString().replace(/Fly$/i, "Flying");
      listaUnificada.push([match[1], c.nome, c.cs, faseFinal, c.mrr, c.lider]);
    }
  }

  abaUnificados.clear().getRange(1, 1, 1, 6).setValues([["ID Original", "Cliente", "CS", "Fase", "MRR", "Lider Ongoing"]]).setFontWeight("bold").setBackground("#E0E0E0");
  if (listaUnificada.length > 0) abaUnificados.getRange(2, 1, listaUnificada.length, 6).setValues(listaUnificada);
}

/**
 * ETAPA 2: DISTRIBUI√á√ÉO E EQUALIZA√á√ÉO
 */
function distribuirCarteiras(modo, parametro) {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const abaUnificados = ss.getSheetByName("Dados Unificados");
  const abaDepois = ss.getSheetByName("Depois");
  const clientes = abaUnificados.getDataRange().getValues().slice(1);
  
  let analistasAlvo = [];
  let analistasAtuais = [...new Set(clientes.map(c => c[2]).filter(cs => cs !== ""))];

  if (modo === "CRIAR") {
    let novos = Array.from({length: parametro}, (_, i) => "Analista " + (i + 1));
    analistasAlvo = [...analistasAtuais, ...novos];
  } else if (modo === "DISSOLVER") {
    analistasAlvo = analistasAtuais.filter(a => !parametro.includes(a));
  } else {
    // MODO EQUALIZAR: Usa todos os analistas atuais sem remover nem adicionar ningu√©m
    analistasAlvo = analistasAtuais;
  }

  // Ordena√ß√£o Serpente (Equil√≠brio por Fase e Valor)
  clientes.sort((a, b) => {
    if (a[3] < b[3]) return -1;
    if (a[3] > b[3]) return 1;
    return (parseFloat(b[4]) || 0) - (parseFloat(a[4]) || 0);
  });

  let resultadoExibicao = [["ID ORIGINAL", "CLIENTE", "NOVO ANALISTA", "L√çDER ONGOING", "FASE", "MRR"]];
  let stats = {};
  analistasAlvo.forEach(n => stats[n] = { mayday: 0, alert: 0, enroute: 0, flying: 0, total: 0, mrr: 0 });

  clientes.forEach((cliente, i) => {
    let turno = Math.floor(i / analistasAlvo.length);
    let dir = i % analistasAlvo.length;
    let idxA = (turno % 2 === 0) ? dir : (analistasAlvo.length - 1 - dir);
    let analistaDestino = analistasAlvo[idxA];
    let analistaOriginal = cliente[2];
    let lider = cliente[5];

    // L√ìGICA DE EXIBI√á√ÉO (Clientes Afetados):
    if (modo === "CRIAR") {
      if (analistaDestino.startsWith("Analista ")) {
        resultadoExibicao.push([cliente[0], cliente[1], analistaDestino, lider, cliente[3], cliente[4]]);
      }
    } else {
      // DISSOLVER ou EQUALIZAR: Mostra apenas se o dono mudou
      if (analistaDestino !== analistaOriginal) {
        resultadoExibicao.push([cliente[0], cliente[1], analistaDestino, lider, cliente[3], cliente[4]]);
      }
    }

    let f = cliente[3].toString().toLowerCase();
    if (f.includes("mayday")) stats[analistaDestino].mayday++;
    else if (f.includes("alert")) stats[analistaDestino].alert++;
    else if (f.includes("en route")) stats[analistaDestino].enroute++;
    else if (f.includes("flying")) stats[analistaDestino].flying++;
    
    stats[analistaDestino].total = stats[analistaDestino].mayday + stats[analistaDestino].alert + stats[analistaDestino].enroute + stats[analistaDestino].flying;
    stats[analistaDestino].mrr += (parseFloat(cliente[4]) || 0);
  });

  abaDepois.clear().clearFormats();
  if (resultadoExibicao.length > 1) {
    abaDepois.getRange(1, 1, resultadoExibicao.length, 6).setValues(resultadoExibicao);
    abaDepois.getRange(1, 1, 1, 6).setFontWeight("bold").setBackground("#444444").setFontColor("white");
    abaDepois.getRange(2, 6, resultadoExibicao.length - 1, 1).setNumberFormat("R$ #,##0.00");
  }

  let resumoData = [["Lista de Analistas", "Mayday", "Alert", "En Route", "Flying", "Total Clientes", "Total MRR"]];
  analistasAlvo.forEach(n => {
    resumoData.push([n, stats[n].mayday, stats[n].alert, stats[n].enroute, stats[n].flying, stats[n].total, stats[n].mrr]);
  });

  abaDepois.getRange(1, 9, resumoData.length, 7).setValues(resumoData);
  abaDepois.getRange(1, 9, 1, 7).setFontWeight("bold").setBackground("#F3F3F3");
  abaDepois.getRange(2, 15, resumoData.length - 1, 1).setNumberFormat("R$ #,##0.00");
  abaDepois.getRange(1, 9, resumoData.length, 7).setBorder(true, true, true, true, true, true);

  abaDepois.setColumnWidth(2, 250); abaDepois.setColumnWidth(3, 150); abaDepois.setColumnWidth(4, 150); 
  abaDepois.setColumnWidth(9, 180); abaDepois.setColumnWidth(15, 120); 

  criarBackupNoDrive(modo);
  SpreadsheetApp.getUi().alert("‚úÖ Processo de " + modo + " conclu√≠do!\nBackup salvo no Drive.");
}

/**
 * BACKUP
 */
function criarBackupNoDrive(modo) {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const abaDepois = ss.getSheetByName("Depois");
  const usuario = Session.getEffectiveUser().getEmail().split("@")[0];
  const dataHoje = Utilities.formatDate(new Date(), "GMT-3", "dd/MM/yyyy");
  
  let prefixo = "Montagem_carteira";
  if (modo === "DISSOLVER") prefixo = "Distribuicao_carteira";
  if (modo === "EQUALIZAR") prefixo = "Equalizacao_carteira";
  
  const timestamp = Utilities.formatDate(new Date(), "GMT-3", "HH-mm");
  const nomeArquivo = `${prefixo}(${dataHoje} - Vers√£o ${timestamp} - Executado por ${usuario})`;

  const novoSS = SpreadsheetApp.create(nomeArquivo);
  abaDepois.copyTo(novoSS);
  const sheetPadrao = novoSS.getSheetByName("P√°gina1") || novoSS.getSheetByName("Sheet1");
  if (sheetPadrao) novoSS.deleteSheet(sheetPadrao);
  ss.toast("Backup criado: " + nomeArquivo, "Drive", 3);
}

function onOpen() {
  SpreadsheetApp.getUi().createMenu('üöÄ Automa√ß√£o CS').addItem('Rodar Processo Completo', 'executarAutomacaoCompleta').addToUi();
}
