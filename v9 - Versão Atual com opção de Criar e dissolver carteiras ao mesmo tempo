/**
 * FUN√á√ÉO PRINCIPAL: Menu expandido com 3 op√ß√µes.
 */
function executarAutomacaoCompleta() {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const ui = SpreadsheetApp.getUi();
  
  const menuMsg = "Escolha a opera√ß√£o desejada:\n\n" +
                  "1) ‚ûï Criar novas carteiras\n" +
                  "2) üóëÔ∏è Dissolver carteiras existentes\n" +
                  "3) üîÑ MISTO: Dissolver e Criar ao mesmo tempo\n\n" +
                  "Digite o n√∫mero da op√ß√£o (1, 2 ou 3):";
                  
  const promptInicial = ui.prompt("üöÄ Gest√£o de Carteiras", menuMsg, ui.ButtonSet.OK_CANCEL);
  
  if (promptInicial.getSelectedButton() !== ui.Button.OK) return;
  const opcao = promptInicial.getResponseText().trim();

  let modo = "";
  let parametro = null;

  // OP√á√ÉO 1: CRIAR
  if (opcao === "1") {
    modo = "CRIAR";
    const prompt = ui.prompt("Montagem de Carteira", "Quantas novas carteiras voc√™ deseja montar?", ui.ButtonSet.OK_CANCEL);
    if (prompt.getSelectedButton() !== ui.Button.OK) return;
    const nNovas = parseInt(prompt.getResponseText());
    if (isNaN(nNovas) || nNovas <= 0) return ui.alert("Insira um n√∫mero v√°lido.");
    parametro = nNovas;

  // OP√á√ÉO 2: DISSOLVER
  } else if (opcao === "2") {
    modo = "DISSOLVER";
    parametro = solicitarDissolucao(ui, ss);
    if (!parametro) return;

  // OP√á√ÉO 3: MISTO
  } else if (opcao === "3") {
    modo = "MISTO";
    const listaDissolver = solicitarDissolucao(ui, ss);
    if (!listaDissolver) return;

    const promptCriar = ui.prompt("Passo 2 de 2: Criar", "Quantas novas carteiras ser√£o criadas?", ui.ButtonSet.OK_CANCEL);
    if (promptCriar.getSelectedButton() !== ui.Button.OK) return;
    const nNovas = parseInt(promptCriar.getResponseText());
    if (isNaN(nNovas) || nNovas <= 0) return ui.alert("Insira um n√∫mero v√°lido.");

    parametro = { sair: listaDissolver, novos: nNovas };

  } else {
    return ui.alert("Op√ß√£o inv√°lida.");
  }

  unificarDados(modo);
  distribuirCarteiras(modo, parametro);
}

/**
 * FUN√á√ÉO AUXILIAR: Pede a lista de quem vai sair
 */
function solicitarDissolucao(ui, ss) {
  const abaClientes = ss.getSheetByName("Tabela clientes");
  const dados = abaClientes.getDataRange().getValues();
  const cabecalho = dados[0];
  const norm = (t) => t ? t.toString().trim().toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "") : "";
  const idxCS = cabecalho.findIndex(c => norm(c) === "cs");
  
  let analistas = [...new Set(dados.slice(1).map(r => r[idxCS]).filter(c => c !== ""))].sort();
  let listaTxt = analistas.map((a, i) => (i + 1) + ") " + a).join("\n");
  
  const prompt = ui.prompt("üóëÔ∏è Dissolver Carteiras", 
    "Digite os N√öMEROS dos CSs que sa√≠ram (separe por v√≠rgula, ex: 1, 3):\n\n" + listaTxt, 
    ui.ButtonSet.OK_CANCEL);
  
  if (prompt.getSelectedButton() !== ui.Button.OK) return null;
  
  let escolhas = prompt.getResponseText().split(",").map(n => parseInt(n.trim()) - 1);
  let nomes = escolhas.map(i => analistas[i]).filter(n => n !== undefined);
  
  if (nomes.length === 0) {
    ui.alert("Sele√ß√£o inv√°lida.");
    return null;
  }
  return nomes;
}

/**
 * ETAPA 1: UNIFICA√á√ÉO
 */
function unificarDados(modo) {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const abaClientes = ss.getSheetByName("Tabela clientes");
  const abaJornada = ss.getSheetByName("Tabela jornada");
  const abaUnificados = ss.getSheetByName("Dados Unificados");
  
  ss.toast("Cruzando dados...", "Etapa 1", 2);

  const dadosClientes = abaClientes.getDataRange().getValues();
  const dadosJornada = abaJornada.getDataRange().getValues();
  const cabecalhoCli = dadosClientes[0];

  const norm = (t) => t ? t.toString().trim().toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "") : "";
  const localizar = (nome) => cabecalhoCli.findIndex(c => norm(c) === norm(nome));

  const idxId = localizar("ID ORIGINAL"), idxCS = localizar("CS"), idxLider = localizar("Lider Ongoing"),
        idxFase = localizar("Fase"), idxMRR = localizar("MRR"), idxNome = localizar("Cliente");

  const jornadaVazia = (dadosJornada.length <= 1 || (dadosJornada.length === 2 && !dadosJornada[1][0]));

  let listaUnificada = [];

  if (jornadaVazia) {
    for (let i = 1; i < dadosClientes.length; i++) {
      let id = dadosClientes[i][idxId].toString().trim();
      if (!id) continue;
      let c = dadosClientes[i];
      let faseFinal = c[idxFase].toString().replace(/Fly$/i, "Flying");
      listaUnificada.push([id, c[idxNome], c[idxCS], faseFinal, c[idxMRR], c[idxLider]]);
    }
  } else {
    let mapaClientes = {};
    for (let i = 1; i < dadosClientes.length; i++) {
      let id = dadosClientes[i][idxId].toString().trim();
      if (id) mapaClientes[id] = { nome: dadosClientes[i][idxNome], cs: dadosClientes[i][idxCS], fase: dadosClientes[i][idxFase], mrr: dadosClientes[i][idxMRR], lider: dadosClientes[i][idxLider] };
    }

    const fasesIncluir = ["mayday", "alert", "en route", "fly", "flying", "onboarding", "retomada"];
    const excluir = ["cancelado", "tratativa de cancelamento"];

    for (let j = 1; j < dadosJornada.length; j++) {
      let celula = dadosJornada[j][0].toString();
      if (!celula) continue;
      let texto = celula.toLowerCase();

      if (excluir.some(termo => texto.includes(termo))) continue;
      if (!fasesIncluir.some(termo => texto.includes(termo))) continue;

      let match = celula.match(/"(\d+)"\s*$/);
      if (match && mapaClientes[match[1]]) {
        let c = mapaClientes[match[1]];
        let faseFinal = c.fase.toString().replace(/Fly$/i, "Flying");
        listaUnificada.push([match[1], c.nome, c.cs, faseFinal, c.mrr, c.lider]);
      }
    }
  }

  abaUnificados.clear().getRange(1, 1, 1, 6).setValues([["ID Original", "Cliente", "CS", "Fase", "MRR", "Lider Ongoing"]]).setFontWeight("bold").setBackground("#E0E0E0");
  if (listaUnificada.length > 0) abaUnificados.getRange(2, 1, listaUnificada.length, 6).setValues(listaUnificada);
}

/**
 * ETAPA 2: DISTRIBUI√á√ÉO E BACKUP
 */
function distribuirCarteiras(modo, parametro) {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const abaUnificados = ss.getSheetByName("Dados Unificados");
  const abaDepois = ss.getSheetByName("Depois");
  
  ss.toast("Equilibrando MRR...", "Etapa 2", 2);

  const clientes = abaUnificados.getDataRange().getValues().slice(1);
  let analistasAlvo = [];
  let analistasAtuais = [...new Set(clientes.map(c => c[2]).filter(cs => cs !== ""))];

  if (modo === "CRIAR") {
    let novos = Array.from({length: parametro}, (_, i) => "Analista " + (i + 1));
    analistasAlvo = [...analistasAtuais, ...novos];
  } else if (modo === "DISSOLVER") {
    analistasAlvo = analistasAtuais.filter(a => !parametro.includes(a));
  } else if (modo === "MISTO") {
    let remanescentes = analistasAtuais.filter(a => !parametro.sair.includes(a));
    let novos = Array.from({length: parametro.novos}, (_, i) => "Analista " + (i + 1));
    analistasAlvo = [...remanescentes, ...novos];
  }

  clientes.sort((a, b) => {
    if (a[3] < b[3]) return -1;
    if (a[3] > b[3]) return 1;
    return (parseFloat(b[4]) || 0) - (parseFloat(a[4]) || 0);
  });

  let resultadoExibicao = [["ID ORIGINAL", "CLIENTE", "NOVO ANALISTA", "L√çDER ONGOING", "FASE", "MRR"]];
  let stats = {};
  analistasAlvo.forEach(n => stats[n] = { mayday: 0, alert: 0, enroute: 0, flying: 0, total: 0, mrr: 0 });

  clientes.forEach((cliente, i) => {
    let turno = Math.floor(i / analistasAlvo.length);
    let dir = i % analistasAlvo.length;
    let idxA = (turno % 2 === 0) ? dir : (analistasAlvo.length - 1 - dir);
    let analistaDestino = analistasAlvo[idxA];
    let analistaOriginal = cliente[2];
    let lider = cliente[5];

    let incluirNoRelatorio = false;
    if (modo === "CRIAR") {
      if (analistaDestino.startsWith("Analista ")) incluirNoRelatorio = true;
    } else if (modo === "DISSOLVER") {
      if (parametro.includes(analistaOriginal)) incluirNoRelatorio = true;
    } else if (modo === "MISTO") {
      let pertenciaAoDissolvido = parametro.sair.includes(analistaOriginal);
      let foiParaNovo = analistaDestino.startsWith("Analista ");
      if (pertenciaAoDissolvido || foiParaNovo) incluirNoRelatorio = true;
    }

    if (incluirNoRelatorio) {
      resultadoExibicao.push([cliente[0], cliente[1], analistaDestino, lider, cliente[3], cliente[4]]);
    }

    let f = cliente[3].toString().toLowerCase();
    if (f.includes("mayday")) stats[analistaDestino].mayday++;
    else if (f.includes("alert")) stats[analistaDestino].alert++;
    else if (f.includes("en route")) stats[analistaDestino].enroute++;
    else if (f.includes("flying")) stats[analistaDestino].flying++;
    
    stats[analistaDestino].total = stats[analistaDestino].mayday + stats[analistaDestino].alert + stats[analistaDestino].enroute + stats[analistaDestino].flying;
    stats[analistaDestino].mrr += (parseFloat(cliente[4]) || 0);
  });

  abaDepois.clear().clearFormats();
  if (resultadoExibicao.length > 1) {
    abaDepois.getRange(1, 1, resultadoExibicao.length, 6).setValues(resultadoExibicao);
    abaDepois.getRange(1, 1, 1, 6).setFontWeight("bold").setBackground("#444444").setFontColor("white");
    abaDepois.getRange(2, 6, resultadoExibicao.length - 1, 1).setNumberFormat("R$ #,##0.00");
  }

  let resumoData = [["Lista de Analistas", "Mayday", "Alert", "En Route", "Flying", "Total Clientes", "Total MRR"]];
  analistasAlvo.forEach(n => {
    resumoData.push([n, stats[n].mayday, stats[n].alert, stats[n].enroute, stats[n].flying, stats[n].total, stats[n].mrr]);
  });

  abaDepois.getRange(1, 9, resumoData.length, 7).setValues(resumoData);
  abaDepois.getRange(1, 9, 1, 7).setFontWeight("bold").setBackground("#F3F3F3");
  abaDepois.getRange(2, 15, resumoData.length - 1, 1).setNumberFormat("R$ #,##0.00");
  abaDepois.getRange(1, 9, resumoData.length, 7).setBorder(true, true, true, true, true, true);
  
  abaDepois.setColumnWidth(2, 250); 
  abaDepois.setColumnWidth(3, 150); 
  abaDepois.setColumnWidth(4, 150); 
  abaDepois.setColumnWidth(9, 180); 
  abaDepois.setColumnWidth(15, 120); 

  // Chama a fun√ß√£o de backup, que agora vai perguntar e salvar na pasta certa
  criarBackupNoDrive(modo);
}

/**
 * FUN√á√ÉO DE BACKUP INTELIGENTE (COM ID AUTOM√ÅTICO)
 */
function criarBackupNoDrive(modo) {
  // --- CONFIGURA√á√ÉO DA PASTA PADR√ÉO ---
  const ID_PASTA_PADRAO = "1ZMJiTnLE66GAFAtn3y7ws7ZOs8UesgY-"; 
  // ------------------------------------

  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const ui = SpreadsheetApp.getUi();
  const abaDepois = ss.getSheetByName("Depois");

  // 1. Pergunta se quer fazer backup
  const resposta = ui.alert("Backup", "Deseja salvar uma c√≥pia (backup) no Google Drive?", ui.ButtonSet.YES_NO);
  
  if (resposta == ui.Button.NO) {
    ui.alert("‚úÖ Processo conclu√≠do sem backup!");
    return;
  }

  // 2. Prepara o nome do arquivo
  const usuario = Session.getEffectiveUser().getEmail().split("@")[0];
  const dataHoje = Utilities.formatDate(new Date(), "GMT-3", "dd/MM/yyyy");
  let prefixo = "";
  if (modo === "CRIAR") prefixo = "Montagem_carteira";
  else if (modo === "DISSOLVER") prefixo = "Distribuicao_carteira";
  else prefixo = "Misto_Carteira";

  const timestamp = Utilities.formatDate(new Date(), "GMT-3", "HH-mm");
  const nomeArquivo = `${prefixo}(${dataHoje} - Vers√£o ${timestamp} - Executado por ${usuario})`;

  // 3. Cria o arquivo
  const novoSS = SpreadsheetApp.create(nomeArquivo);
  abaDepois.copyTo(novoSS);
  
  const sheetPadrao = novoSS.getSheetByName("P√°gina1") || novoSS.getSheetByName("Sheet1");
  if (sheetPadrao) novoSS.deleteSheet(sheetPadrao);

  // 4. Move para a pasta padr√£o
  try {
    const arquivo = DriveApp.getFileById(novoSS.getId());
    const pastaDestino = DriveApp.getFolderById(ID_PASTA_PADRAO);
    arquivo.moveTo(pastaDestino);
    ui.alert("‚úÖ Processo conclu√≠do!\nBackup salvo na pasta padr√£o do Drive.");
  } catch (e) {
    ui.alert("‚úÖ Processo conclu√≠do!\n(Aviso: ID da pasta inv√°lido ou sem permiss√£o. Backup salvo no 'Meu Drive').");
  }
}

function onOpen() {
  SpreadsheetApp.getUi().createMenu('üöÄ Automa√ß√£o CS').addItem('Rodar Processo Completo', 'executarAutomacaoCompleta').addToUi();
}
